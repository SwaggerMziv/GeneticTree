# -*- coding: utf-8 -*-
"""AI промпты для генерации семейной книги"""

# --- Per-style narration instructions ---

STYLE_INSTRUCTIONS = {
    "classic": """
Стиль: КЛАССИЧЕСКИЙ (формальный, элегантный)
- Пиши в третьем лице, с уважительным тоном
- Используй сложносочинённые предложения, книжную лексику
- Избегай разговорных выражений и сленга
- Тон: торжественный, уважительный, как в мемуарах
- Пример: "В далёком 1952 году семья Ивановых приняла судьбоносное решение..."
""",
    "modern": """
Стиль: СОВРЕМЕННЫЙ (разговорный, лёгкий)
- Пиши просто и живо, как будто рассказываешь другу
- Короткие предложения, динамичный ритм
- Можно использовать вопросы к читателю и восклицания
- Тон: тёплый, дружеский, с юмором где уместно
- Пример: "Представьте себе: 1952 год, маленький городок, и семья Ивановых решает всё изменить..."
""",
    "vintage": """
Стиль: ВИНТАЖНЫЙ (ностальгический, поэтичный)
- Пиши с нотками ностальгии, как старинная летопись
- Используй метафоры, сравнения, образный язык
- Обращай внимание на атмосферу, запахи, звуки эпохи
- Тон: мечтательный, поэтичный, с лёгкой грустью по ушедшим временам
- Пример: "Сквозь пожелтевшие страницы времени проступает история семьи Ивановых, начавшаяся в туманном 1952 году..."
""",
}

# --- Grounding (anti-hallucination) instructions ---

GROUNDING_RULES = """
ВАЖНЫЕ ПРАВИЛА (ОБЯЗАТЕЛЬНО СОБЛЮДАЙ):
1. Используй ТОЛЬКО факты из предоставленных данных. НЕ выдумывай события, даты, имена или детали.
2. Если информация о ком-то скудная — напиши поэтично о том, что известно, без домыслов.
3. Вместо выдуманных деталей используй обобщения: "в те непростые годы", "как вспоминают в семье".
4. Если дата неизвестна — НЕ придумывай год, используй "в одно время", "в те годы".
5. Цитаты и диалоги ЗАПРЕЩЕНЫ, если их нет в исходных историях.
6. Если в данных указано "неизвестно" — не додумывай значение, пропусти или обобщи.
"""

# --- Photo marker instructions for chapter writing ---

PHOTO_INSTRUCTIONS = """
ФОТОГРАФИИ (ОБЯЗАТЕЛЬНО — ВСТАВЬ ВСЕ):
Ты ОБЯЗАН вставить КАЖДУЮ фотографию из списка ниже в текст главы.
Используй маркеры ТОЧНО в формате: [PHOTO:relative_id:story_key:media_index]
Копируй маркеры ДОСЛОВНО из списка — не изменяй ни одного символа.

Доступные фотографии для этой главы:
{available_photos}

ПРАВИЛА:
1. Вставь АБСОЛЮТНО ВСЕ фотографии из списка выше. Ни одна не должна быть пропущена.
2. Каждый маркер — на ОТДЕЛЬНОЙ строке, между двумя абзацами текста.
3. Вставляй фото в тот момент повествования, где упоминается соответствующий человек или история.
4. Фото из историй вставляй когда пересказываешь или упоминаешь эту историю.
5. Между двумя фото должен быть хотя бы один абзац текста.
6. НЕ повторяй один и тот же маркер дважды.
7. Если фото профиля — вставляй при первом упоминании человека в главе.
"""

# --- Temperature mapping per style ---

STYLE_TEMPERATURES = {
    "classic": 0.6,
    "modern": 0.75,
    "vintage": 0.85,
    "custom": 0.7,
}

# --- Prompts ---

BOOK_OUTLINE_PROMPT = """Ты - талантливый семейный историк и писатель. Создай увлекательную структуру для книги о семейной истории на основе предоставленных данных.

ДАННЫЕ СЕМЬИ:
{family_context}

{grounding_rules}

{style_instructions}

ТРЕБОВАНИЯ:
1. Создай захватывающее название для книги
2. Напиши введение, которое погружает читателя в историю семьи (2-3 абзаца)
3. Организуй главы по темам, событиям или эпохам (НЕ просто по людям)
4. Каждая глава должна иметь драматическую структуру: завязка, развитие, кульминация
5. Сфокусируйся на связях между людьми, ключевых моментах и семейных традициях
6. Если есть истории - вплети их в повествование
7. Укажи, какие родственники должны появиться в каждой главе

Ответь ТОЛЬКО в формате JSON:
{{
  "title": "Название книги",
  "introduction": "Текст введения (2-3 абзаца)",
  "chapters": [
    {{
      "title": "Название главы 1",
      "theme": "О чём эта глава",
      "relatives_to_include": [1, 2, 3],
      "key_events": ["событие1", "событие2"],
      "narrative_arc": "Краткое описание сюжетной линии"
    }}
  ],
  "conclusion_theme": "Что должно быть в заключении"
}}

Язык ответа: {language}
"""

CHAPTER_WRITING_PROMPT = """Ты - талантливый семейный историк и писатель. Напиши увлекательную главу для семейной книги.

ТЕМА ГЛАВЫ: {chapter_theme}
НАЗВАНИЕ ГЛАВЫ: {chapter_title}

РОДСТВЕННИКИ В ЭТОЙ ГЛАВЕ:
{relatives_data}

ДОСТУПНЫЕ ИСТОРИИ И КОНТЕКСТ:
{stories_context}

СВЯЗИ МЕЖДУ ЭТИМИ РОДСТВЕННИКАМИ:
{relationships_context}

{grounding_rules}

{style_instructions}

{photo_instructions}

ТРЕБОВАНИЯ:
1. Пиши в нарративном стиле согласно указанным инструкциям стиля, НЕ сухой список фактов
2. Используй приёмы драматургии: завязка, нарастание, кульминация, развязка
3. Добавь чувственные детали и эмоциональные моменты, но ТОЛЬКО на основе предоставленных данных
4. Свяжи индивидуальные истории с общими семейными темами
5. Если есть даты - вплети их естественно в повествование
6. Длина: примерно 500-800 слов
7. Закончи плавным переходом к следующим событиям

Язык: {language}

Напиши ТОЛЬКО текст главы, без заголовка и метаданных.
"""

TIMELINE_PROMPT = """Создай хронологию ключевых событий для этой семьи.

ДАННЫЕ СЕМЬИ:
{family_context}

{grounding_rules}

Извлеки и организуй ТОЛЬКО реальные даты из предоставленных данных:
- Даты рождения
- Даты смерти
- Свадьбы (из связей типа spouse/husband/wife)
- Любые даты из историй

НЕ выдумывай даты. Если точная дата неизвестна — не включай событие.

Ответь ТОЛЬКО в формате JSON массива:
[
  {{"year": 1950, "event": "Описание события", "relative_ids": [1, 2]}}
]

Сортируй по году. Язык: {language}
"""

CONCLUSION_PROMPT = """Напиши проникновенное заключение для семейной книги.

ТЕМА: {theme}
КРАТКИЙ ОБЗОР СЕМЬИ: {family_overview}

{grounding_rules}

{style_instructions}

Требования:
- Подведи итог семейного пути на основе реальных данных
- Отрази общие ценности и традиции
- Посмотри в будущее с надеждой
- 2-3 абзаца
- Язык: {language}

Напиши ТОЛЬКО текст заключения.
"""

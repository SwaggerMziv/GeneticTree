# Telegram-–±–æ—Ç —Å–µ–º–µ–π–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞

–ë–æ—Ç –¥–ª—è —Å–±–æ—Ä–∞ —Å–µ–º–µ–π–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–≤—å—é. –†–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —Å—Å—ã–ª–∫—É-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ, –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –∫ –±–æ—Ç—É –∏ –æ—Ç–≤–µ—á–∞—é—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –±–æ—Ç —Å–∞–º –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤ –∫—Ä–∞—Å–∏–≤—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ —Å–µ–º–µ–π–Ω–æ–µ –¥—Ä–µ–≤–æ.

## –ß—Ç–æ —É–º–µ–µ—Ç –±–æ—Ç

- **–ü—Ä–æ–≤–æ–¥–∏—Ç –∏–Ω—Ç–µ—Ä–≤—å—é** ‚Äî –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å—ã –æ –∂–∏–∑–Ω–∏, –¥–µ—Ç—Å—Ç–≤–µ, —Å–µ–º—å–µ, —Ä–∞–±–æ—Ç–µ
- **–†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤—ã–µ** ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞–≥–æ–≤–æ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é, –±–æ—Ç —Å–∞–º –ø–µ—Ä–µ–≤–µ–¥—ë—Ç –≤ —Ç–µ–∫—Å—Ç
- **–°–æ–∑–¥–∞—ë—Ç –∏—Å—Ç–æ—Ä–∏–∏** ‚Äî –∏–∑ –¥–∏–∞–ª–æ–≥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Å–≤—è–∑–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞
- **–ù–∞–ø–æ–º–∏–Ω–∞–µ—Ç –æ —Å–µ–±–µ** ‚Äî —Ä–∞–∑ –≤ 12 —á–∞—Å–æ–≤ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å, —á—Ç–æ–±—ã —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫ –Ω–µ –∑–∞–±—ã–≤–∞–ª –¥–µ–ª–∏—Ç—å—Å—è –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ–º–µ–π–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç** ‚Äî –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥—Ä—É–≥–∏—Ö —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤

---

## –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π –∏ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

–≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, —Å–≤—è–∑—ã–≤–∞—é—â–∏–π –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç–∞ –∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö PostgreSQL.

### –û–±—â–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. –í–õ–ê–î–ï–õ–ï–¶ –î–†–ï–í–ê (Frontend)                                   ‚îÇ
‚îÇ     - –°–æ–∑–¥–∞—ë—Ç —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –Ω–∞ —Å–∞–π—Ç–µ                             ‚îÇ
‚îÇ     - –ù–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤ Telegram"                          ‚îÇ
‚îÇ     - –ü–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. BACKEND API                                                 ‚îÇ
‚îÇ     - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ç–æ–∫–µ–Ω (secrets.token_urlsafe)‚îÇ
‚îÇ     - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω –≤ –ë–î: relative.invitation_token           ‚îÇ
‚îÇ     - –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É: https://t.me/bot?start={token}          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. –†–û–î–°–¢–í–ï–ù–ù–ò–ö                                                 ‚îÇ
‚îÇ     - –ü–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫—É (email, WhatsApp, SMS)                    ‚îÇ
‚îÇ     - –ö–ª–∏–∫–∞–µ—Ç –ø–æ —Å—Å—ã–ª–∫–µ                                         ‚îÇ
‚îÇ     - Telegram –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–æ—Ç–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º start={token}        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  4. TELEGRAM BOT                                                ‚îÇ
‚îÇ     - –ü–æ–ª—É—á–∞–µ—Ç /start {token}                                   ‚îÇ
‚îÇ     - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω + telegram_user_id –Ω–∞ –±—ç–∫–µ–Ω–¥             ‚îÇ
‚îÇ     - –ë—ç–∫–µ–Ω–¥ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞         ‚îÇ
‚îÇ     - –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ (Backend)

**–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `POST /api/v1/family/{user_id}/relatives/{relative_id}/generate-invitation`

**–¢—Ä–µ–±—É–µ—Ç:** JWT-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥—Ä–µ–≤–∞

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫ –µ—â—ë –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ `secrets.token_urlsafe(32)`
4. –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –≤ –ø–æ–ª–µ `invitation_token`
5. –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞

**–ö–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞ (repository.py):**
```python
async def generate_invitation_token(self, relative_id: int, user_id: int) -> str:
    import secrets

    # –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π 32-–±–∞–π—Ç–æ–≤—ã–π —Ç–æ–∫–µ–Ω (URL-safe Base64)
    token = secrets.token_urlsafe(32)

    stmt = update(FamilyRelationModel).where(
        FamilyRelationModel.id == relative_id,
        FamilyRelationModel.user_id == user_id
    ).values(invitation_token=token)

    await self.session.execute(stmt)
    return token
```

**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:**
```json
{
    "invitation_url": "https://t.me/genetic_tree_bot?start=AbCdEfGhIjKlMnOp...",
    "token": "AbCdEfGhIjKlMnOp...",
    "relative_id": 42,
    "relative_name": "–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–Ω–∞"
}
```

#### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π

**–¢–∞–±–ª–∏—Ü–∞:** `family_relations` (–º–æ–¥–µ–ª—å `FamilyRelationModel`)

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `invitation_token` | VARCHAR(64), UNIQUE, INDEX | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è |
| `telegram_user_id` | BIGINT, INDEX | Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ |
| `telegram_id` | VARCHAR | Telegram username (@username) |
| `is_activated` | BOOLEAN | –§–ª–∞–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false) |
| `activated_at` | TIMESTAMP WITH TZ | –í—Ä–µ–º—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ |

**–ò–Ω–¥–µ–∫—Å—ã:**
- `invitation_token` ‚Äî –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–æ–∫–µ–Ω—É O(1)
- `telegram_user_id` ‚Äî –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –ø–æ Telegram ID

#### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–∫–∏ –≤ –±–æ—Ç–µ (start.py)

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç —Å—Å—ã–ª–∫—É `https://t.me/bot?start=TOKEN`, Telegram –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–æ—Ç–∞ –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –∫–æ–º–∞–Ω–¥—É `/start TOKEN`.

**–ö–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
```python
@router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    args = message.text.split(maxsplit=1)

    if len(args) > 1:
        # –ï—Å—Ç—å —Ç–æ–∫–µ–Ω ‚Äî —ç—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é
        token = args[1]

        try:
            # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥
            relative_data = await backend_api.activate_user(
                token=token,
                telegram_user_id=message.from_user.id,
                username=message.from_user.username
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ FSM-—Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é
            await state.update_data(
                relative_id=relative_data["id"],
                relative_name=f"{relative_data['first_name']} {relative_data['last_name']}"
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫
            user_storage.add_user(
                telegram_id=message.from_user.id,
                relative_id=relative_data["id"],
                name=relative_name,
                enabled_broadcast=True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–∞–µ–º —Ä–∞—Å—Å—ã–ª–∫—É
            )

            await message.answer("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! ...")

        except httpx.HTTPStatusError as e:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (—Å–º. –Ω–∏–∂–µ)
            ...
    else:
        # –û–±—ã—á–Ω—ã–π /start –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        user_data = user_storage.get_user(message.from_user.id)
        if user_data:
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é
            await state.update_data(
                relative_id=user_data["relative_id"],
                relative_name=user_data.get("name", "")
            )
```

#### 4. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ –±—ç–∫–µ–Ω–¥–µ

**–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `POST /api/v1/family/activate-invitation`

**–ù–µ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** ‚Äî —ç—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –±–æ—Ç–∞

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
    "token": "AbCdEfGhIjKlMnOp...",
    "telegram_user_id": 123456789,
    "telegram_username": "maria_ivanova"
}
```

**–õ–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (service.py):**
```python
async def activate_invitation(self, token: str, telegram_user_id: int, telegram_username: str = None):
    # 1. –ò—â–µ–º —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –ø–æ —Ç–æ–∫–µ–Ω—É
    relative = await self.repository.get_by_invitation_token(token)
    if not relative:
        raise InvalidInvitationTokenError()  # 404

    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—â—ë –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
    if relative.is_activated:
        raise RelativeAlreadyActivatedError(relative.id)  # 400

    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ—Ç Telegram-–∞–∫–∫–∞—É–Ω—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫—É
    existing = await self.repository.get_by_telegram_user_id(telegram_user_id)
    if existing and existing.id != relative.id:
        raise TelegramUserAlreadyLinkedError(telegram_user_id)  # 400

    # 4. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º
    return await self.repository.activate_relative(
        relative.id, telegram_user_id, telegram_username
    )
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (repository.py):**
```python
async def activate_relative(self, relative_id: int, telegram_user_id: int, telegram_username: str = None):
    update_data = {
        'telegram_user_id': telegram_user_id,
        'is_activated': True,
        'activated_at': datetime.now(timezone.utc)
    }

    if telegram_username:
        update_data['telegram_id'] = telegram_username

    stmt = update(FamilyRelationModel).where(
        FamilyRelationModel.id == relative_id
    ).values(**update_data).returning(FamilyRelationModel)

    result = await self.session.execute(stmt)
    return result.scalar_one()
```

#### 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

| –û—à–∏–±–∫–∞ | HTTP –∫–æ–¥ | –ö–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç | –û—Ç–≤–µ—Ç –±–æ—Ç–∞ |
|--------|----------|-----------------|------------|
| `InvalidInvitationTokenError` | 404 | –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç—ë–∫ | "–ù–µ–≤–µ—Ä–Ω–∞—è –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Å—Å—ã–ª–∫–∞. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—É—é." |
| `RelativeAlreadyActivatedError` | 400 | –ü—Ä–æ—Ñ–∏–ª—å —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω | "–≠—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /interview" |
| `TelegramUserAlreadyLinkedError` | 400 | Telegram-–∞–∫–∫–∞—É–Ω—Ç —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫—É | "–≠—Ç–æ—Ç Telegram-–∞–∫–∫–∞—É–Ω—Ç —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é." |

**–ö–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –±–æ—Ç–µ:**
```python
except httpx.HTTPStatusError as e:
    if e.response.status_code == 404:
        await message.answer(
            "–ù–µ–≤–µ—Ä–Ω–∞—è –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Å—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ.\n"
            "–ü–æ–ø—Ä–æ—Å–∏—Ç–µ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞–º –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É."
        )
    elif e.response.status_code == 400:
        error_data = e.response.json()
        error_type = error_data.get("details", {}).get("error_type", "")

        if error_type == "telegram_user_already_linked":
            await message.answer(
                "–≠—Ç–æ—Ç Telegram-–∞–∫–∫–∞—É–Ω—Ç —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é.\n\n"
                "–û–¥–∏–Ω Telegram-–∞–∫–∫–∞—É–Ω—Ç = –æ–¥–∏–Ω —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫ –≤ –∞—Ä—Ö–∏–≤–µ."
            )
        else:  # already_activated
            await message.answer(
                "–≠—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /interview –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é."
            )
```

#### 6. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –±–æ—Ç–∞ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ (–ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–ª –±–æ—Ç–∞), –±–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:

```python
else:
    # /start –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
    user_data = user_storage.get_user(message.from_user.id)
    if user_data:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –±—ã–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ
        await state.update_data(
            relative_id=user_data["relative_id"],
            relative_name=user_data.get("name", "")
        )
        await message.answer("–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! –ü—Ä–æ–¥–æ–ª–∂–∏–º?")
    else:
        # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ —Å—Å—ã–ª–∫–∏
        await message.answer(
            "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é –æ—Ç —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞."
        )
```

### –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (Redis)

–î–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Redis –≤–º–µ—Å—Ç–æ PostgreSQL –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –±—ç–∫–µ–Ω–¥:

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ (Redis):**
```python
import secrets
import redis.asyncio as redis

async def generate_invitation_token(relative_id: int) -> str:
    token = secrets.token_urlsafe(32)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Redis —Å TTL (–Ω–∞–ø—Ä–∏–º–µ—Ä, 7 –¥–Ω–µ–π)
    await redis_client.setex(
        f"invitation:{token}",
        timedelta(days=7),
        json.dumps({"relative_id": relative_id})
    )

    return token
```

**–ê–∫—Ç–∏–≤–∞—Ü–∏—è (Redis):**
```python
async def activate_invitation(token: str, telegram_user_id: int):
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Ç–æ–∫–µ–Ω—É
    data = await redis_client.get(f"invitation:{token}")
    if not data:
        raise InvalidInvitationTokenError()

    invitation = json.loads(data)
    relative_id = invitation["relative_id"]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ telegram_user_id
    existing = await redis_client.get(f"telegram:{telegram_user_id}")
    if existing:
        raise TelegramUserAlreadyLinkedError()

    # –°–≤—è–∑—ã–≤–∞–µ–º telegram_user_id —Å relative_id
    await redis_client.set(
        f"telegram:{telegram_user_id}",
        json.dumps({"relative_id": relative_id, "activated_at": datetime.now().isoformat()})
    )

    # –£–¥–∞–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
    await redis_client.delete(f"invitation:{token}")

    return {"relative_id": relative_id}
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª—é—á–µ–π –≤ Redis:**
```
invitation:{token}     ‚Üí {"relative_id": 42}              # TTL: 7 –¥–Ω–µ–π
telegram:{user_id}     ‚Üí {"relative_id": 42, ...}         # –ë–µ–∑ TTL
relative:{relative_id} ‚Üí {"telegram_user_id": 123456789}  # –ë–µ–∑ TTL
```

### –î–∏–∞–≥—Ä–∞–º–º–∞ –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     PostgreSQL (Backend)                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  family_relations                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ id             ‚îÇ invitation_token‚îÇ telegram_user_id        ‚îÇ ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ  ‚îÇ 42             ‚îÇ AbCdEf...      ‚îÇ NULL (–¥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏)     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ 42             ‚îÇ AbCdEf...      ‚îÇ 123456789 (–ø–æ—Å–ª–µ)       ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  + is_activated: false ‚Üí true                                   ‚îÇ
‚îÇ  + activated_at: NULL ‚Üí 2024-01-15T10:30:00Z                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Local Storage (Bot)                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  data/users.json                                                ‚îÇ
‚îÇ  {                                                              ‚îÇ
‚îÇ    "users": {                                                   ‚îÇ
‚îÇ      "123456789": {           ‚Üê telegram_user_id                ‚îÇ
‚îÇ        "relative_id": 42,     ‚Üê —Å–≤—è–∑—å —Å –ë–î                      ‚îÇ
‚îÇ        "name": "–ú–∞—Ä–∏—è",                                         ‚îÇ
‚îÇ        "enabled_broadcast": true                                ‚îÇ
‚îÇ      }                                                          ‚îÇ
‚îÇ    }                                                            ‚îÇ
‚îÇ  }                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd telegram_bot
python -m venv venv

# Windows
venv\Scripts\activate

# Linux/Mac
source venv/bin/activate

pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `.env` –≤ –ø–∞–ø–∫–µ `telegram_bot`:

```env
TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
BACKEND_URL=http://localhost:8000
OPENAI_API_KEY=sk-...

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
BROADCAST_ENABLED=true
```

**–ì–¥–µ –≤–∑—è—Ç—å —Ç–æ–∫–µ–Ω—ã:**
- `TELEGRAM_BOT_TOKEN` ‚Äî —Å–æ–∑–¥–∞–π –±–æ—Ç–∞ —á–µ—Ä–µ–∑ [@BotFather](https://t.me/BotFather), –æ–Ω –≤—ã–¥–∞—Å—Ç —Ç–æ–∫–µ–Ω
- `OPENAI_API_KEY` ‚Äî –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ [OpenAI](https://platform.openai.com/api-keys)

### 3. –ó–∞–ø—É—Å–∫

```bash
python main.py
```

–ï—Å–ª–∏ –≤—Å—ë –æ–∫, —É–≤–∏–¥–∏—à—å –≤ –∫–æ–Ω—Å–æ–ª–∏:
```
INFO - Starting Family Archive Bot...
INFO - No webhook set
INFO - Broadcast scheduler started (interval: 12h)
INFO - Starting polling...
```

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞)

1. –í–ª–∞–¥–µ–ª–µ—Ü –¥—Ä–µ–≤–∞ —Å–æ–∑–¥–∞—ë—Ç –Ω–∞ —Å–∞–π—Ç–µ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
2. –†–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ ‚Äî –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –±–æ—Ç–∞
3. –ë–æ—Ç –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∞–∫–∫–∞—É–Ω—Ç –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–∞—á–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é
4. –†–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã (—Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –≥–æ–ª–æ—Å–æ–º)
5. –ü–æ—Å–ª–µ –∫–∞–∂–¥—ã—Ö 3 –æ—Ç–≤–µ—Ç–æ–≤ –±–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
6. –†–∞–∑ –≤ 12 —á–∞—Å–æ–≤ –±–æ—Ç –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å –Ω–æ–≤—ã–º –≤–æ–ø—Ä–æ—Å–æ–º

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Telegram API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ –ë–æ—Ç (aiogram)
                                            ‚îÇ
                                            ‚îú‚îÄ‚îÄ‚ñ∫ OpenAI (–∏–Ω—Ç–µ—Ä–≤—å—é + Whisper)
                                            ‚îÇ
                                            ‚îî‚îÄ‚îÄ‚ñ∫ Backend API (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–π)
                                                      ‚îÇ
                                                      ‚ñº
                                                 PostgreSQL
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
telegram_bot/
‚îú‚îÄ‚îÄ main.py              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
‚îú‚îÄ‚îÄ config.py            # –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
‚îú‚îÄ‚îÄ requirements.txt     # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ
‚îú‚îÄ‚îÄ bot/                 # –í—Å—ë —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –±–æ—Ç–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ instance.py      # –û–±—ä–µ–∫—Ç—ã Bot –∏ Dispatcher
‚îÇ   ‚îú‚îÄ‚îÄ handlers/        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ start.py     # /start –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ —Å—Å—ã–ª–∫–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commands.py  # /help, /stats, /stop
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ interview.py # –õ–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ—Ä–≤—å—é
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.py  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.py     # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/       # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ menus.py
‚îÇ   ‚îú‚îÄ‚îÄ states/          # FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ interview.py
‚îÇ   ‚îî‚îÄ‚îÄ scheduler/       # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
‚îÇ       ‚îî‚îÄ‚îÄ broadcast.py # –†–∞—Å—Å—ã–ª–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
‚îÇ
‚îú‚îÄ‚îÄ services/            # –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ api.py           # –ö–ª–∏–µ–Ω—Ç –¥–ª—è –±—ç–∫–µ–Ω–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ ai.py            # –†–∞–±–æ—Ç–∞ —Å OpenAI
‚îÇ   ‚îî‚îÄ‚îÄ storage.py       # –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ
‚îî‚îÄ‚îÄ data/                # –î–∞–Ω–Ω—ã–µ (–Ω–µ –∫–æ–º–º–∏—Ç—è—Ç—Å—è)
    ‚îî‚îÄ‚îÄ users.json       # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
```

---

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

| –ö–æ–º–∞–Ω–¥–∞ | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
|---------|------------|
| `/start` | –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ —Å—Å—ã–ª–∫–µ |
| `/start {token}` | –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ —Å—Å—ã–ª–∫–µ-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é |
| `/interview` | –ù–∞—á–∞—Ç—å –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é |
| `/stats` | –°–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—Ä–∏–π –∑–∞–ø–∏—Å–∞–Ω–æ |
| `/settings` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ |
| `/help` | –°–ø—Ä–∞–≤–∫–∞ |
| `/stop` | –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é |

---

## –ò–Ω—Ç–µ—Ä–≤—å—é

### –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–æ

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ù–∞—á–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é"
2. –ë–æ—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ–º—å–∏ (–∏—Å—Ç–æ—Ä–∏–∏ –¥—Ä—É–≥–∏—Ö —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤)
3. –ë–æ—Ç –∑–∞–¥–∞—ë—Ç –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å (—á–µ—Ä–µ–∑ OpenAI GPT-4o)
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –≥–æ–ª–æ—Å–æ–º
5. –ë–æ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –∏ –∑–∞–¥–∞—ë—Ç —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å
6. –ü–æ—Å–ª–µ 3+ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
7. –ë–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–≤—è–∑–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞
8. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç

### FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è

```python
class InterviewStates(StatesGroup):
    waiting_answer = State()      # –ñ–¥—ë–º –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å
    confirming_story = State()    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
```

### –ü—Ä–æ–º–ø—Ç –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é

–ë–æ—Ç –≤–µ–¥—ë—Ç —Å–µ–±—è –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä ‚Äî –Ω–µ —Ö–≤–∞–ª–∏—Ç, –Ω–µ –≤–æ—Å—Ö–∏—â–∞–µ—Ç—Å—è, –∑–∞–¥–∞—ë—Ç –∫–æ—Ä–æ—Ç–∫–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:

```
‚úì "–ü–æ–Ω—è–ª. –ê —Ä–æ–¥–∏—Ç–µ–ª–∏ –∑–Ω–∞–ª–∏, —á—Ç–æ –≤—ã —Ç—É–¥–∞ –ø–æ–µ—Ö–∞–ª–∏?"
‚úì "–ö–∞–∫ –ø–æ—Ç–æ–º —Å–ª–æ–∂–∏–ª–∏—Å—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –ê—Ä—Ç—ë–º–æ–º?"

‚úó "–≠—Ç–æ –∑–≤—É—á–∏—Ç –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–µ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ! –ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ!"
```

–ë–æ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç, –∫–∞–∫–∏–µ —Ç–µ–º—ã —É–∂–µ –æ–±—Å—É–∂–¥–∞–ª–∏—Å—å, –∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –Ω–∏–º.

### –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

–ë–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤—ã–µ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ Whisper API:

```
üéß –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—é –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...

üìù *–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞:*
_–ù—É –≤–æ—Ç, –∑–Ω–∞—á–∏—Ç, –±—ã–ª–æ –º–Ω–µ —Ç–æ–≥–¥–∞ –ª–µ—Ç –≤–æ—Å–µ–º—å..._
```

–ü–æ—Å–ª–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Ç–µ–∫—Å—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç.

### –°–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–π

–ò–∑ –¥–∏–∞–ª–æ–≥–∞ –±–æ—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å–≤—è–∑–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞:

```
üìñ *–õ–µ—Ç–Ω–∏–π –ª–∞–≥–µ—Ä—å –Ω–∞ –æ–∑–µ—Ä–µ*

–ú–Ω–µ –±—ã–ª–æ –≤–æ—Å–µ–º—å –ª–µ—Ç, –∫–æ–≥–¥–∞ —Ä–æ–¥–∏—Ç–µ–ª–∏ –≤–ø–µ—Ä–≤—ã–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –º–µ–Ω—è –≤ –ª–µ—Ç–Ω–∏–π
–ª–∞–≥–µ—Ä—å. –ü–æ–º–Ω—é, –∫–∞–∫ —Å–∏–ª—å–Ω–æ –±–æ—è–ª—Å—è –µ—Ö–∞—Ç—å –æ–¥–∏–Ω...
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞:** –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –≤ –¥–∏–∞–ª–æ–≥–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π (–∏–º–µ–Ω–∞, –¥–∞—Ç—ã, –º–µ—Å—Ç–∞). –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç—ã —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ –∏–ª–∏ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é.

---

## –†–∞—Å—Å—ã–ª–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

–ö–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤ –±–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∫–æ–º—É –ø–æ—Ä–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ. –≠—Ç–æ –Ω–µ —Å–ø–∞–º ‚Äî –ø—Ä–æ—Å—Ç–æ —Ç—ë–ø–ª–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º —Ç–∏–ø–∞:

> –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –ú–∞—Ä–∏—è!
>
> –£ –º–µ–Ω—è –µ—Å—Ç—å –¥–ª—è –≤–∞—Å –≤–æ–ø—Ä–æ—Å:
>
> *–ö–∞–∫–æ–µ —Å–∞–º–æ–µ —è—Ä–∫–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–∑ –¥–µ—Ç—Å—Ç–≤–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤–∞–º –Ω–∞ —É–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?*
>
> –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∏—Å—Ç–æ—Ä–∏–µ–π!

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (`/settings`) –∏–ª–∏ –ø—Ä—è–º–æ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è.

### –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏

–ë–æ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –∏–∑ —Å–ø–∏—Å–∫–∞ (20 —à—Ç—É–∫):

- –ö–∞–∫–æ–µ —Å–∞–º–æ–µ —è—Ä–∫–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–∑ –¥–µ—Ç—Å—Ç–≤–∞?
- –ö—Ç–æ –±—ã–ª –≤–∞—à–∏–º –ª—É—á—à–∏–º –¥—Ä—É–≥–æ–º –≤ —à–∫–æ–ª–µ?
- –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–≤–æ—ë–º –ø–µ—Ä–≤–æ–º —Ä–∞–±–æ—á–µ–º –¥–Ω–µ
- –ö–∞–∫–æ–π —Å–æ–≤–µ—Ç –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π –≤—ã –ø–æ–º–Ω–∏—Ç–µ –¥–æ —Å–∏—Ö –ø–æ—Ä?
- –û–ø–∏—à–∏—Ç–µ —Å–∞–º—ã–π –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–π—Å—è –ø—Ä–∞–∑–¥–Ω–∏–∫ –≤ —Å–µ–º—å–µ
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑ –∂–∏–∑–Ω–∏ –±–∞–±—É—à–∫–∏ –∏–ª–∏ –¥–µ–¥—É—à–∫–∏
- –ú–æ–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–º–µ–Ω–∏–ª –≤–∞—à—É –∂–∏–∑–Ω—å
- –í–∞—à–µ —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
- –õ—é–±–∏–º–æ–µ —Å–µ–º–µ–π–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ
- –¢—Ä–∞–¥–∏—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–¥–∞—Ç—å –¥–µ—Ç—è–º
- –ö–∞–∫ –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å —Å–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–∫–æ–π
- –ö–∞–∫–æ–π —É—Ä–æ–∫ –∂–∏–∑–Ω–∏ —É—Å–≤–æ–∏–ª–∏ –Ω–∞ –æ–ø—ã—Ç–µ
- –ß–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—ã–π —Å–∏–ª—å–Ω–æ –ø–æ–≤–ª–∏—è–ª –Ω–∞ –∂–∏–∑–Ω—å
- –ë–ª—é–¥–æ, –∫–æ—Ç–æ—Ä–æ–µ –≥–æ—Ç–æ–≤–∏–ª–∞ –º–∞–º–∞/–±–∞–±—É—à–∫–∞
- –î–æ–º, –≤ –∫–æ—Ç–æ—Ä–æ–º –≤—ã—Ä–æ—Å–ª–∏
- –ú—É–∑—ã–∫–∞ –∏–ª–∏ –ø–µ—Å–Ω—è –∏–∑ –º–æ–ª–æ–¥–æ—Å—Ç–∏
- –ü–µ—Ä–≤—ã–π –¥–æ–º–∞—à–Ω–∏–π –ø–∏—Ç–æ–º–µ—Ü
- –°–∞–º—ã–π —Å–º–µ—à–Ω–æ–π —Å–ª—É—á–∞–π –≤ –∂–∏–∑–Ω–∏
- –ß—Ç–æ –±—ã —Å–∫–∞–∑–∞–ª–∏ —Å–µ–±–µ –º–æ–ª–æ–¥–æ–º—É
- –ö–∞–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–ª–∏ –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π

–í–æ–ø—Ä–æ—Å—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –ø–æ–¥—Ä—è–¥ ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è, –∫–∞–∫–æ–π –≤–æ–ø—Ä–æ—Å –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–º.

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–≤—à–∏—Ö –±–æ—Ç–∞

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞, —Ä–∞—Å—Å—ã–ª–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è:

```python
if "blocked" in error_str.lower() or "deactivated" in error_str.lower():
    user_storage.set_broadcast_enabled(user["telegram_id"], False)
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏

–í `.env` –º–æ–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É:

```env
BROADCAST_ENABLED=false
```

–ò–Ω—Ç–µ—Ä–≤–∞–ª (12 —á–∞—Å–æ–≤) –∑–∞–¥–∞—ë—Ç—Å—è –≤ `config.py`:

```python
BROADCAST_INTERVAL_HOURS: int = 12
```

---

## API –±—ç–∫–µ–Ω–¥–∞

–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
|-------|----------|------------|
| POST | `/api/v1/family/activate-invitation` | –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ —Ç–æ–∫–µ–Ω—É (–ø—É–±–ª–∏—á–Ω—ã–π) |
| GET | `/api/v1/family/relative-by-telegram/{id}` | –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ |
| POST | `/api/v1/family/relatives/{id}/story` | –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é |
| GET | `/api/v1/family/relatives/{id}/stories-count` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—Ä–∏–π |
| GET | `/api/v1/family/relatives/active-telegram` | –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ |
| GET | `/api/v1/family/relatives/{id}/related-stories` | –ò—Å—Ç–æ—Ä–∏–∏ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ |

### –î–µ—Ç–∞–ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

**POST /api/v1/family/activate-invitation**

–ü—É–±–ª–∏—á–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç (–±–µ–∑ JWT), –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –±–æ—Ç–æ–º.

Request:
```json
{
    "token": "AbCdEfGhIjKlMnOp...",
    "telegram_user_id": 123456789,
    "telegram_username": "maria_ivanova"
}
```

Response (200):
```json
{
    "id": 42,
    "first_name": "–ú–∞—Ä–∏—è",
    "last_name": "–ò–≤–∞–Ω–æ–≤–Ω–∞",
    "is_activated": true,
    "telegram_user_id": 123456789,
    "activated_at": "2024-01-15T10:30:00Z"
}
```

Errors:
- 404: `{"detail": "Invalid or expired invitation token"}`
- 400: `{"detail": "...", "details": {"error_type": "already_activated"}}`
- 400: `{"detail": "...", "details": {"error_type": "telegram_user_already_linked"}}`

---

## –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–î–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –±–æ—Ç —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ –≤ `data/users.json`:

```json
{
  "users": {
    "123456789": {
      "relative_id": 42,
      "name": "–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–Ω–∞",
      "enabled_broadcast": true,
      "last_interaction": "2024-01-15T10:30:00",
      "added_at": "2024-01-10T14:20:00",
      "broadcast_count": 5,
      "last_question_index": 7
    }
  },
  "broadcast_history": [],
  "last_broadcast": "2024-01-15T08:00:00"
}
```

–≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã:
- –ó–Ω–∞—Ç—å, –∫–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –ù–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –≤–æ–ø—Ä–æ—Å
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, –∫—Ç–æ –æ—Ç–∫–ª—é—á–∏–ª —Ä–∞—Å—Å—ã–ª–∫—É
- –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–µ—Å—Å–∏—é –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞

---

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫

1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª –≤ `bot/handlers/`
2. –û–ø—Ä–µ–¥–µ–ª–∏ —Ä–æ—É—Ç–µ—Ä:

```python
from aiogram import Router, F
from aiogram.types import Message

router = Router()

@router.message(F.text == "üÜï –ú–æ—è –∫–æ–º–∞–Ω–¥–∞")
async def my_handler(message: Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç!")
```

3. –ü–æ–¥–∫–ª—é—á–∏ –≤ `bot/handlers/__init__.py`:

```python
from bot.handlers.my_handler import router as my_router

def setup_routers() -> Router:
    main_router = Router()
    main_router.include_router(my_router)  # –î–æ–±–∞–≤—å —Å—é–¥–∞
    # ...
    return main_router
```

### –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É

–í `bot/keyboards/menus.py`:

```python
def get_my_keyboard() -> ReplyKeyboardMarkup:
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–ö–Ω–æ–ø–∫–∞ 1")],
            [KeyboardButton(text="–ö–Ω–æ–ø–∫–∞ 2")],
        ],
        resize_keyboard=True,
    )
```

### –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏

–í `config.py` –Ω–∞–π–¥–∏ —Å–ø–∏—Å–æ–∫ `BROADCAST_QUESTIONS` –∏ –¥–æ–±–∞–≤—å —Å–≤–æ–π:

```python
BROADCAST_QUESTIONS = [
    # ...—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã...
    "–í–∞—à –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å?",
]
```

---

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å —Ç–æ–∫–µ–Ω –≤ `.env`
2. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –±—ç–∫–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
3. –ü–æ—Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ ‚Äî —Ç–∞–º –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞

### "AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

–ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –¥–µ–Ω—å–≥–∏ –Ω–∞ OpenAI –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü—Ä–æ–≤–µ—Ä—å –±–∞–ª–∞–Ω—Å.

### –†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –£–±–µ–¥–∏—Å—å, —á—Ç–æ `BROADCAST_ENABLED=true`
2. –ü—Ä–æ–≤–µ—Ä—å, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ `data/users.json`
3. –†–∞—Å—Å—ã–ª–∫–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑ –≤ 12 —á–∞—Å–æ–≤ ‚Äî –º–æ–∂–µ—Ç, –ø—Ä–æ—Å—Ç–æ –µ—â—ë –Ω–µ –≤—Ä–µ–º—è

### –ì–æ–ª–æ—Å–æ–≤—ã–µ –Ω–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—é—Ç—Å—è

Whisper API —Ç–æ–∂–µ –ø–ª–∞—Ç–Ω—ã–π. –ü—Ä–æ–≤–µ—Ä—å –±–∞–ª–∞–Ω—Å OpenAI.

### "–ù–µ–≤–µ—Ä–Ω–∞—è –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Å—Å—ã–ª–∫–∞"

–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
- –°—Å—ã–ª–∫–∞ –±—ã–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è (dev/prod)
- –†–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫ –±—ã–ª —É–¥–∞–ª—ë–Ω –∏–∑ –¥—Ä–µ–≤–∞
- –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏

---

## –õ–æ–≥–∏

–ë–æ—Ç –ø–∏—à–µ—Ç –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—å. –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –≤ `main.py`:

```python
logging.basicConfig(
    level=logging.DEBUG,  # –ë—ã–ª–æ INFO
    ...
)
```

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **aiogram 3.x** ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å Telegram API
- **httpx** ‚Äî HTTP-–∫–ª–∏–µ–Ω—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±—ç–∫–µ–Ω–¥—É
- **openai** ‚Äî SDK –¥–ª—è OpenAI (GPT + Whisper)
- **python-dotenv** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

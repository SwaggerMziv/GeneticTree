"""Bot configuration and constants."""
import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """Bot configuration."""

    # Tokens and URLs
    BOT_TOKEN: str = os.getenv("TELEGRAM_BOT_TOKEN", "")
    BACKEND_URL: str = os.getenv("BACKEND_URL", "http://localhost:8000")
    OPENAI_API_KEY: str = os.getenv("OPENAI_API_KEY", "")

    # Interview settings
    MESSAGES_BEFORE_STORY: int = 4  # 4 вопроса на одну историю
    MAX_CONVERSATION_LENGTH: int = 24

    # AI Models
    STORY_SUMMARY_MODEL: str = "gpt-4o"
    INTERVIEW_MODEL: str = "gpt-4o"

    # Scheduler settings
    BROADCAST_INTERVAL_HOURS: int = 12
    BROADCAST_ENABLED: bool = os.getenv("BROADCAST_ENABLED", "true").lower() == "true"


# Interview topics for variety - теперь более конкретные и провоцирующие
INTERVIEW_TOPICS = [
    "момент гордости отца/матери",
    "семейная тайна или секрет",
    "первая серьёзная ссора с родителями",
    "день, который изменил всё",
    "человек, который предал",
    "неожиданная дружба",
    "самый страшный момент в жизни",
    "решение, о котором жалеешь",
    "запрещённое в детстве",
    "первые заработанные деньги",
    "любовь, которая не сложилась",
    "момент, когда понял что повзрослел",
    "семейная реликвия и её история",
    "традиция, которую ненавидел в детстве",
    "самый честный разговор с родителем",
    "детская мечта и что с ней стало",
    "момент прощения",
    "секрет успеха в семье",
    "урок от бабушки/дедушки",
    "история знакомства родителей",
]

# Questions for broadcast messages - более цепляющие и конкретные
BROADCAST_QUESTIONS = [
    "Был момент, когда ты видел слёзы на глазах отца или матери? Что тогда случилось?",
    "Какой семейный секрет ты узнал уже будучи взрослым?",
    "Опиши момент, когда родители тобой по-настоящему гордились. Что ты чувствовал?",
    "Была ситуация в детстве, за которую тебе до сих пор стыдно?",
    "Кто из родственников казался тебе странным в детстве? Почему?",
    "Помнишь момент, когда впервые осознал, что родители тоже могут ошибаться?",
    "Какой подарок от родных ты помнишь лучше всего? Почему именно он?",
    "Была фраза от бабушки или дедушки, которая засела в голове на всю жизнь?",
    "Опиши запах дома, в котором ты вырос. Что он тебе напоминает?",
    "Был человек в семье, с которым ты мог говорить обо всём? Кто это был?",
    "Какое наказание от родителей запомнилось больше всего? За что?",
    "Был момент, когда ты защищал кого-то из родных? Что произошло?",
    "Что готовила бабушка такого, что никто больше не умеет?",
    "Какую семейную историю рассказывали так часто, что ты знаешь её наизусть?",
    "Был момент, когда ты разочаровал родителей? Как это было?",
    "Какая музыка играла в доме твоего детства?",
    "Опиши руки своей бабушки или дедушки. Что они тебе напоминают?",
    "Была семейная традиция, которую ты ненавидел, а теперь скучаешь по ней?",
    "Кто первый заметил в тебе талант или способность? Как это было?",
    "Какой совет от родителей ты игнорировал, а потом понял, что они были правы?",
    "Был момент, когда ты хотел убежать из дома? Что тогда происходило?",
    "Какую вещь из детства ты хранишь до сих пор? Почему она важна?",
    "Помнишь момент, когда впервые увидел родителей как обычных людей, а не как родителей?",
    "Какой был самый громкий скандал в семье, который ты помнишь?",
    "Была история, которую родители скрывали, а ты случайно узнал?",
]

# AI Prompts
INTERVIEW_SYSTEM_PROMPT = """Ты интервьюер для семейного архива. Твоя задача — вытянуть РЕАЛЬНЫЕ истории с конкретными деталями.

═══ ОГРАНИЧЕНИЕ ПО ВОПРОСАМ ═══
После 5-7 вопросов на одну тему — ЗАВЕРШИ сбор информации.
Если уже собрано: хотя бы 1 событие + 1 имя + 1 деталь — скажи:
"Отличная история! Нажмите «Создать историю» чтобы сохранить её."

НЕ ПРОДОЛЖАЙ бесконечно. Лучше создать историю из имеющихся данных, чем задавать вопросы до бесконечности.

═══ ГЛАВНОЕ ПРАВИЛО ═══
Если человек отвечает коротко ("нет", "не помню", "ничего") — НЕ СДАВАЙСЯ сразу.
Переформулируй вопрос конкретнее или предложи другую тему. Но после 2-3 коротких ответов подряд смени тактику полностью.

═══ ОБЯЗАТЕЛЬНО ИСПОЛЬЗУЙ КОНТЕКСТ ═══
Если ниже есть информация о родственниках и их историях — НАЧИНАЙ С НЕЁ:
- "Твоя бабушка Мария рассказывала о переезде в 60-х. Ты помнишь её истории об этом?"
- "В архиве есть история о войне от твоего деда. Он тебе рассказывал об этом лично?"
- "Твоя мать упоминала семейный дом в деревне. Ты там бывал?"

Если контекста нет — спрашивай о конкретных вещах:
- Конкретный человек: "Расскажи об одном дне с бабушкой, который запомнился"
- Конкретное место: "Опиши кухню в доме, где ты вырос"
- Конкретное событие: "Первый день в школе — что помнишь?"
- Конкретный предмет: "Была вещь, которую ты прятал от родителей?"

═══ ЗАПРЕЩЕНО ═══
- Абстрактные вопросы: "Расскажи о детстве", "Какие были отношения с родителями"
- Философские вопросы: "Что для тебя значит семья"
- Оценочные: "Было ли детство счастливым"

═══ ВМЕСТО ЭТОГО ═══
- "Что готовила бабушка на праздники? Опиши запах и вкус."
- "Был случай, когда родители тебя несправедливо наказали?"
- "Самый громкий семейный скандал, который помнишь?"
- "Что ты прятал под подушкой или в тайнике?"

═══ ЕСЛИ ЧЕЛОВЕК ОТВЕЧАЕТ КОРОТКО ═══
НЕ: "Ладно, расскажи что-нибудь другое"
ДА: "Окей. А был случай, когда ты сильно испугался в детстве? Что случилось?"

Дай человеку конкретную зацепку — место, время, эмоцию, человека.

═══ ФОРМАТ ОТВЕТА ═══
Только вопрос. Без похвалы, без "отлично!", без длинных вступлений.
Короткая реакция (1-3 слова) + конкретный вопрос.

Примеры:
- "Понял. А какой был голос у деда? Громкий, тихий?"
- "Так. Опиши комнату, где это произошло."
- "Ясно. Кто из родных был рядом в тот момент?"

═══ СБОР ДЕТАЛЕЙ ═══
Для хорошей истории нужны: имена, места, даты (хотя бы примерные), описания людей, эмоции, диалоги, последствия. Добивайся этих деталей."""

STORY_SUMMARY_PROMPT = """Ты редактор семейного архива. Твоя задача — ТОЧНО пересказать диалог, без добавлений.

═══ ПРОВЕРКА ПЕРЕД СОЗДАНИЕМ ═══

1. Выпиши ВСЕ конкретные факты из ответов рассказчика:
   - Имена людей
   - Даты или годы
   - Места (города, адреса, страны)
   - Конкретные события (что произошло)
   - Детали (профессии, характеристики, диалоги)

2. Если конкретных фактов МЕНЬШЕ 3 — верни НЕДОСТАТОЧНО_ДАННЫХ

Пустые ответы: "нет", "не помню", "ну да", "типа того", "норм", короткие фразы без деталей.

═══ ПРАВИЛА НАПИСАНИЯ ═══

РАЗРЕШЕНО:
- Использовать ТОЛЬКО слова и факты из ответов рассказчика
- Связующие слова: "потом", "тогда", "в тот момент", "после этого"
- Писать от первого лица
- Прямые цитаты из диалога

СТРОГО ЗАПРЕЩЕНО:
- Добавлять факты, которых НЕТ в диалоге
- Добавлять эмоции, которые человек НЕ называл
- Писать "возможно", "наверное", "должно быть", "скорее всего"
- Философские обобщения ("она была хранительницей", "он нёс в себе мудрость")
- Метафоры и художественные образы
- УДЛИНЯТЬ историю добавляя выдумки
- Приписывать мотивы и мысли которые не озвучены

═══ ПРОВЕРКА КАЖДОГО ПРЕДЛОЖЕНИЯ ═══
Каждое предложение истории должно быть ПРЯМОЙ переработкой слов рассказчика.
Если не можешь указать откуда взят факт — удали это предложение.

═══ ДЛИНА ═══
- 1-2 факта = 2-3 предложения
- 3-5 фактов = 1-2 абзаца
- 5+ фактов = 3-4 абзаца МАКСИМУМ

НЕ РАЗДУВАЙ текст. Короткая правдивая история лучше длинной выдуманной.

═══ ФОРМАТ ═══
Если данных достаточно (минимум 3 конкретных факта):
НАЗВАНИЕ: [3-5 слов о главном событии]
ИСТОРИЯ:
[ТОЛЬКО факты из диалога, никаких добавлений]

Если данных НЕ достаточно:
НЕДОСТАТОЧНО_ДАННЫХ: Рассказчик не поделился конкретными историями или деталями."""


# Prompt for detecting mentioned relatives in interview answers
RELATIVE_DETECTION_PROMPT = """Проанализируй ответ пользователя и определи, упоминается ли в нём родственник, о котором можно создать профиль.

═══ ИЩЕМ ═══
- Прямые упоминания с именем: "моя мама Ирина", "дедушка Николай", "брат Сергей"
- Упоминания с конкретной информацией: "мама работала врачом", "отец был военным"
- Упоминания, где есть хоть какая-то деталь о человеке

═══ НЕ СЧИТАЕМ РОДСТВЕННИКОМ ═══
- Абстрактные упоминания без конкретики: "все родители", "бабушки-дедушки вообще"
- Друзей, соседей, коллег, знакомых
- Упоминания без какой-либо информации о человеке

═══ ВАЖНО ═══
- Имя обязательно должно быть указано, иначе found = false
- Если есть имя + хоть одна деталь (профессия, возраст, характер) — это найденный родственник

═══ ФОРМАТ ОТВЕТА ═══
Верни ТОЛЬКО JSON без markdown:
{
    "found": true/false,
    "name": "Имя если найдено" или null,
    "probable_role": "mother/father/brother/sister/grandfather/grandmother/uncle/aunt/son/daughter/spouse/other" или null,
    "context": "Цитата с упоминанием" или null,
    "has_details": true/false
}

ТЕКСТ ДЛЯ АНАЛИЗА:
"""


# Prompt for generating follow-up questions about mentioned relative
RELATIVE_INFO_QUESTION_PROMPT = """Ты собираешь базовую информацию о родственнике.

Имя родственника: {name}
Предполагаемая роль: {role}
Контекст упоминания: {context}

Уже собрана информация:
{collected_info}

Номер вопроса: {question_number} из 3

═══ СТРОГИЙ ПОРЯДОК ВОПРОСОВ ═══

ВОПРОС 1 (если номер = 1):
ОБЯЗАТЕЛЬНО спроси ПОЛНОЕ ИМЯ (имя, отчество, фамилия).
Пример: "Как полностью звали {name}? Имя, отчество, фамилия?"

ВОПРОС 2 (если номер = 2):
ОБЯЗАТЕЛЬНО спроси ГОД РОЖДЕНИЯ или ВОЗРАСТ.
Пример: "В каком году родился(ась) {name}? Или сколько ему/ей примерно лет?"

ВОПРОС 3 (если номер = 3):
Спроси о ПРОФЕССИИ или основном ЗАНЯТИИ.
Пример: "Чем {name} занимался(ась) по работе или в жизни?"

═══ ВАЖНО ═══
- НЕ МЕНЯЙ порядок вопросов!
- НЕ СПРАШИВАЙ про хобби, характер или детали до сбора базовой информации
- Задай ТОЛЬКО вопрос, короткий и конкретный
- Не пиши "Вопрос:" или нумерацию
"""


config = Config()
